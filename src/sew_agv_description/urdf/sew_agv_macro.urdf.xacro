<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

<!--#######################################################################################################################################-->
<!--include the helpers with fixed parameters-->
<!--#######################################################################################################################################-->
  <xacro:include filename="$(find sew_agv_description)/urdf/materials.urdf.xacro" />


<!--#######################################################################################################################################-->
<!--set some parameters with default values used by the macros (kinematics description, simulation and control)-->
<!--#######################################################################################################################################-->

  <xacro:macro name="sew_agv_macro" params="
    tf_prefix
    generate_ros2_control_tag:=false
    standalone_gazebo:=false
    ros2_control_with_gazebo:=false
    use_fake_hardware:=false
    robot_ip
    robot_ssid"
  >

<!--#######################################################################################################################################-->
<!--include ros2 control and create an instance if param generate_ros2_control_tag == true and pass necessary params-->
<!--#######################################################################################################################################-->

    <xacro:if value="${generate_ros2_control_tag}">
        <!-- ros2 control include -->
        <xacro:include filename="$(find sew_agv_description)/urdf/sew_agv.ros2_control.urdf.xacro" />
        <!-- ros2 control instance -->
        <xacro:sew_agv_ros2_control
          use_fake_hardware="${use_fake_hardware}"
          tf_prefix="${tf_prefix}"
          robot_ip="${robot_ip}"
          robot_ssid="${robot_ssid}"
        />
    </xacro:if>


<!--#######################################################################################################################################-->
<!--load gazebo hardware plugin for ros2_control or standard gazebo diff_drive plugin-->
<!--#######################################################################################################################################-->

    <xacro:if value="${ros2_control_with_gazebo}">
        <hardware>
            <plugin>gz_ros2_control/GazeboSimSystem</plugin>
        </hardware>
    </xacro:if>

    <xacro:if value="${standalone_gazebo}">
        <xacro:include filename="$(find sew_agv_description)/urdf/sew_agv_gazebo_macro.urdf.xacro" />
        <xacro:sew_agv_gazebo/>
    </xacro:if>


<!--#######################################################################################################################################-->
<!--define the main kinematic chain with links and joints (using the config-files) PI: 3.14159 PI/2: 1.57079 -->
<!--#######################################################################################################################################-->
    <xacro:materials tf_prefix="${tf_prefix}"/>
    
    
    <!--define non physical footprint joint (used in nav2 to determine robot center on the ground)-->
    <link name="base_footprint"/>

    <!--base/ main body fixed relative to the footprint , inertial definitions required due to the use in gazebo-->
    <joint name="base_footprint_joint" type="fixed">
        <origin rpy="0 0 0" xyz="0 0 0.58"/>
        <axis xyz="0 0 0"/>
        <parent link="base_footprint"/>
        <child link="base_link"/>
    </joint>
    <link name="base_link">
        <inertial>
            <mass value="250"/> <!--in kg-->
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <inertia ixx="3.82" ixy="0.0" ixz="0.48" iyy="4.11" iyz="0.0" izz="3.29"/> <!--not realistic!-->
        </inertial>
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_body.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}grey"/>
        </visual>
        <collision>
            <origin rpy=" 0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/collision/sew_maxo_mts_body.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}red"/>
        </collision>
    </link>

    <!--front wheel / axis should match the rotation axis of the wheel, for simplicity reasons set this to fixed and disable friction in gazebo-->
    <joint name="caster_wheel_joint" type="fixed">
        <origin rpy="1.57079 0 0" xyz="0.290 0 -0.56"/>
        <axis xyz="0 0 0"/>
        <parent link="base_link"/>
        <child link="caster_wheel_link"/>
    </joint>
    <link name="caster_wheel_link" type="wheel">
        <inertial>
            <mass value="2"/>
            <inertia ixx="0.0" ixy="0.0" ixz="0.0" iyy="1.0" iyz="0.0" izz="1.0"/> <!--not realistic!-->
        </inertial>
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_front_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}black"/>
        </visual>
        <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_front_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}red"/>
        </collision>
    </link>

    <!--right back wheel / axis shold match the rotation axis of the wheel-->
    <joint name="wheel_right_joint" type="continuous">
        <origin rpy="0 0 -1.57079" xyz="-0.225 -0.2625 -0.48"/>
        <limit effort="100.0" velocity="3.5"/>
        <axis xyz="-1 0 0"/>
        <parent link="base_link"/>
        <child link="wheel_right_link"/>
        <joint_properties damping="1" friction="1"/>
    </joint>
    <link name="wheel_right_link" type="wheel">
        <inertial>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <mass value="2"/>
            <inertia ixx="0.0" ixy="0.0" ixz="0.0" iyy="1.0" iyz="0.0" izz="1.0"/> <!--not realistic!-->
        </inertial>
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}black"/>
        </visual>
        <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}red"/>
        </collision>
    </link>

    <!--left back wheel / axis shold match the rotation axis of the wheel-->
    <joint name="wheel_left_joint" type="continuous">
        <origin rpy="0 0 1.57079" xyz="-0.225 0.2625 -0.48"/>
        <limit effort="100.0" velocity="3.5"/>
        <axis xyz="1 0 0"/>
        <parent link="base_link"/>
        <child link="wheel_left_link"/>
        <joint_properties damping="5" friction="10"/>
    </joint>
    <link name="wheel_left_link" type="wheel">
        <inertial>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <mass value="2"/>
            <inertia ixx="1.0" ixy="0.0" ixz="0.0" iyy="1.0" iyz="0.0" izz="1.0"/> <!--not realistic!-->
        </inertial>
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}black"/>
        </visual>
        <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_wheel.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}red"/>
        </collision>
    </link>

    <!--lidar sensor, required due to the use in gazebo-->
    <joint name="lidar_joint" type="fixed">
        <axis xyz="0 0 0"/>
        <origin rpy="0 0 0 " xyz="0.355 0 -0.445"/>
        <parent link="base_link"/>
        <child link="lidar_link"/>
    </joint>
    <link name="lidar_link" type="laser">
        <inertial>
            <mass value="1"/>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <inertia ixx="1.0" ixy="0.0" ixz="0.0" iyy="1.0" iyz="0.0" izz="1.0"/> <!--not realistic!-->
        </inertial>
        <visual>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_lidar.stl" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="${tf_prefix}yellow"/>
        </visual>
        <collision>
            <origin rpy="0 0 0" xyz="0 0 0"/>
            <geometry>
                <mesh filename="file://$(find sew_agv_description)/meshes/visual/sew_maxo_mts_lidar.stl" scale="0.001 0.001 0.001"/>
            </geometry>
        </collision>
        <material name="${tf_prefix}red"/>
    </link>

  
  </xacro:macro>
</robot>